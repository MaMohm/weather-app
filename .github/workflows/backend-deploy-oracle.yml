name: Deploy Backend to Oracle Cloud

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'deploy/**'
      - '.github/workflows/backend-deploy-oracle.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install & Build Backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build
          # Prepare artifact
          mkdir ../artifact
          cp package.json package-lock.json ../artifact/
          cp -r dist ../artifact/
          # Copy deploy scripts if needed, though usually we SCP them or run them.
          # We'll rely on the repo 'deploy' folder being synced or just the artifact.
          # The release script needs to be present on the server or uploaded.
          # Let's include the release script in the artifact for simplicity?
          # Actually, prompts said "deploy folder".
          # We'll upload the artifact content to a new release folder.

      - name: Create Release Timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Deploy to Server via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          port: ${{ secrets.ORACLE_PORT }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          source: "artifact/*,deploy/release.sh"
          target: "/tmp/weather-deploy-${{ steps.timestamp.outputs.timestamp }}"
          strip_components: 1

      - name: Execute Release Script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          port: ${{ secrets.ORACLE_PORT }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            # Define paths
            TIMESTAMP="${{ steps.timestamp.outputs.timestamp }}"
            RELEASE_DIR="/var/www/weather-backend/releases/$TIMESTAMP"
            TMP_DIR="/tmp/weather-deploy-$TIMESTAMP"
            
            # Create release directory
            mkdir -p "$RELEASE_DIR"
            
            # Move files from tmp to release dir
            # Note: scp might have put artifact contents directly or in 'artifact' subdir depending on strip_components
            # With strip_components: 1, 'artifact/*' -> target root. 'deploy/release.sh' -> somewhere?
            # Let's adjust scp to be safer.
            # We uploaded 'artifact/*' and 'deploy/release.sh'.
            # If we don't use strip_components, we get 'artifact/...' and 'deploy/...'.
            
            # Let's simplify:
            # Move everything from TMP_DIR to RELEASE_DIR
            cp -r $TMP_DIR/* $RELEASE_DIR/
            
            # Make release script executable
            chmod +x $RELEASE_DIR/deploy/release.sh || chmod +x $RELEASE_DIR/release.sh
            
            # The release script might be at root of release dir if we adjusted paths, OR in deploy/
            # In our SCP: 'artifact/*' contents go to 'artifact/' inside tmp? No, scp 'source' preserves structure unless stripped.
            
            # Let's look at SCP source: "artifact/*,deploy/release.sh"
            # It will likely copy:
            # /tmp/.../package.json
            # /tmp/.../dist/
            # /tmp/.../deploy/release.sh (if full path preserved relative to CWD?)
            
            # Let's assume simplest: We scp the 'artifact' folder content to 'RELEASE_DIR'.
            # We also need 'deploy/release.sh'.
            
            # Let's execute release script
            # We'll try to find it.
            if [ -f "$RELEASE_DIR/release.sh" ]; then
               SCRIPT="$RELEASE_DIR/release.sh"
            elif [ -f "$RELEASE_DIR/deploy/release.sh" ]; then
               SCRIPT="$RELEASE_DIR/deploy/release.sh"
            else
               echo "Release script not found!"
               exit 1
            fi
            
            chmod +x "$SCRIPT"
            "$SCRIPT" "$RELEASE_DIR"
            
            # Cleanup tmp
            rm -rf "$TMP_DIR"
